name: Test
on:
  push:
    branches: ["master"]
  pull_request:

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v6
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'MC Controls/**'
              - '.github/workflows/**'
            frontend:
              - 'WebContent/**'
              - '.github/workflows/**'

  Backend-tests:
    name: Backend tests
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle
      - name: Run tests
        working-directory: MC Controls
        run: ./gradlew test
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          check_name: 'MC-Controls Test Results'
          files: |
            MC Controls/**/build/test-results/test/*.xml

  Frontend-lint:
    name: Frontend lint
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: WebContent/pnpm-lock.yaml
      - name: Install deps
        working-directory: WebContent
        run: pnpm install --frozen-lockfile
      - name: Lint
        working-directory: WebContent
        run: npx nx run-many -t lint -- --format json --output-file dist/eslint-report.json
      - name: ESLint summary
        if: always()
        working-directory: WebContent
        run: |
          echo "## Frontend lint" >> "$GITHUB_STEP_SUMMARY"
          if [ ! -f "dist/eslint-report.json" ]; then
            echo "- No eslint-report.json found (lint may have failed early)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          node - <<'NODE'
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('dist/eslint-report.json', 'utf8'));

          let files = 0, errors = 0, warnings = 0;
          const offenders = [];
          for (const r of report) {
            files++;
            errors += r.errorCount || 0;
            warnings += r.warningCount || 0;
            const total = (r.errorCount || 0) + (r.warningCount || 0);
            if (total) offenders.push({ file: r.filePath, errors: r.errorCount||0, warnings: r.warningCount||0, total });
          }

          offenders.sort((a,b)=>b.total-a.total);
          const top = offenders.slice(0, 10);

          const out = [];
          out.push(`- Files checked: **${files}**`);
          out.push(`- Errors: **${errors}**`);
          out.push(`- Warnings: **${warnings}**`);

          if (top.length) {
            out.push('');
            out.push('**Top files:**');
            for (const t of top) {
              out.push(`- \`${t.file.replace(process.cwd() + '/', '')}\` â€” ${t.errors} error(s), ${t.warnings} warning(s)`);
            }
          }

          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, out.join('\n') + '\n');
          NODE

  Frontend-tests:
    name: Frontend tests
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: WebContent/pnpm-lock.yaml
      - name: Install deps
        working-directory: WebContent
        run: pnpm install --frozen-lockfile
      - name: Run tests
        working-directory: WebContent
        run: npx nx run-many -t test
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          check_name: 'WebContent Test Results'
          files: |
            WebContent/**/dist/test-results/test/*.xml